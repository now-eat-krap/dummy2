<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>Logflow Heatmap Viewer (Snapshot-first)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0b0b0b; color:#eee; }
    .wrap { max-width: 1400px; margin: 24px auto; padding: 0 16px; }
    #viewer { position: relative; width: 1366px; height: 900px; border:1px solid #333; background:#111; overflow:hidden; border-radius:10px; }
    #snapshot, #heatmap { position:absolute; inset:0; width:100%; height:100%; display:block; }
    #snapshot { object-fit: cover; user-select:none; pointer-events:none; }
    header { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
    input, select, button { background:#161616; color:#ddd; border:1px solid #333; border-radius:8px; padding:8px 10px; }
    button { cursor:pointer; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Logflow Heatmap Viewer</h1>
  <div class="row">
    <label>URL</label>
    <input id="url" size="60" value="https://example.com/">
    <label>Viewport</label>
    <select id="vp">
      <option>1366x900</option>
      <option>390x844</option>
    </select>
    <label>Range</label>
    <select id="range">
      <option value="-24h">24h</option>
      <option value="-7d">7d</option>
      <option value="-30d">30d</option>
    </select>
    <button id="load">Load</button>
  </div>

  <div id="viewer" style="margin-top:12px">
    <!-- 스냅샷 로컬 파일 (WebP) -->
    <img id="snapshot" src="" alt="snapshot" />
    <!-- 히트맵 캔버스 -->
    <canvas id="heatmap"></canvas>
  </div>
</div>

<script type="module">
/** 단순한 정적 뷰어 (좌표 → 캔버스) **/
const $ = (s)=>document.querySelector(s);
const cvs = $('#heatmap'); const ctx = cvs.getContext('2d');

function fitCanvas(){
  const r = cvs.getBoundingClientRect();
  cvs.width = Math.floor(r.width);
  cvs.height= Math.floor(r.height);
}
fitCanvas();
addEventListener('resize', fitCanvas);

function sha1(str){
  const enc = new TextEncoder().encode(str);
  return crypto.subtle.digest('SHA-1', enc).then(buf => {
    return Array.from(new Uint8Array(buf)).map(x=>x.toString(16).padStart(2,'0')).join('');
  });
}

async function drawHeatmap(url, vp, range){
  const id = await sha1(url);
  $('#snapshot').src = `/snapshots/${id}/${vp}.webp`;

  const api = 'http://localhost:8081/heatmap?url='+encodeURIComponent(url)+'&range='+encodeURIComponent(range);
  const { ok, points } = await fetch(api).then(r=>r.json());

  ctx.clearRect(0,0,cvs.width,cvs.height);
  const [vw, vh] = vp.split('x').map(Number);

  // 좌표계를 viewer 크기에 맞게 스케일링
  const sx = cvs.width / vw;
  const sy = cvs.height/ vh;

  for (const p of (points||[])) {
    const x = p.x * sx, y = p.y * sy;
    const r = 40 * Math.max(sx, sy);
    const g = ctx.createRadialGradient(x, y, 1, x, y, r);
    g.addColorStop(0, 'rgba(255,0,0,0.6)');
    g.addColorStop(1, 'rgba(255,0,0,0)');
    ctx.fillStyle = g;
    ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill();
  }
}

$('#load').addEventListener('click', () => {
  const url = $('#url').value.trim();
  const vp  = $('#vp').value;
  const range = $('#range').value;
  drawHeatmap(url, vp, range);
});
</script>
</body>
</html>
